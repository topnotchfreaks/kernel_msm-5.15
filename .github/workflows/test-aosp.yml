name: "AOSP Kernel Build"

env:
  DEVICE: "GKI"
  KERNEL_BRANCH: ${{ github.event.inputs.kernelBranch }}

on:
  workflow_dispatch:
    inputs:
      kernelBranch:
        description: "AOSP Kernel branch (default if empty)"
        required: false
        type: string
        default: "common-android13-5.15-lts"

jobs:
  Build-AOSP-Kernel:
    name: "🛠 Build AOSP Kernel"
    runs-on: ubuntu-latest
    env:
      WORK_DIR: ${{ github.workspace }}
      KERNEL_DIR: "common"
      OUT_DIR: "out"
      ANDROID_KERNEL_BRANCH: ${{ github.event.inputs.kernelBranch }}
    
    steps:
      - name: "🚀 Setup environment"
        run: |
          sudo apt-get update && \
          sudo apt-get install -y repo rsync
      
      - name: "📥 Initialize repo"
        working-directory: ${{ env.WORK_DIR}}
        run: |
          repo init -u https://android.googlesource.com/kernel/manifest -b $ANDROID_KERNEL_BRANCH --depth=1
          repo sync --optimized-fetch --prune -j8

          rm -rf .repo
          # rm -rf prebuilts/clang/host/linux-x86

          # git clone --depth=1 --recursive https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 -b main prebuilts/clang/host/linux-x86

          # rm -rf prebuilts/clang/host/linux-x86/clang-3289846
          # rm -rf prebuilts/clang/host/linux-x86/clang-r522817
          # rm -rf prebuilts/clang/host/linux-x86/clang-r530567
          # rm -rf prebuilts/clang/host/linux-x86/clang-r536225
          # rm -rf prebuilts/clang/host/linux-x86/clang-stable

          # sed -i \
          #   -e 's/^BRANCH=.*/BRANCH=android13-5.15/' \
          #   -e 's/^CLANG_VERSION=.*/CLANG_VERSION=r547379/' \
          #   common/build.config.constants

      - name: "🧩 Apply GKI Fixup Patches"
        if: contains(env.ANDROID_KERNEL_BRANCH, '5.15')
        working-directory: ${{ env.WORK_DIR}}/common
        run: |
          set -e
          log() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1"; }

          PATCH_URLS=(
            "https://raw.githubusercontent.com/topnotchfreaks/kernel_patches/main/0001-gki-fixup.patch"
            "https://raw.githubusercontent.com/topnotchfreaks/kernel_patches/main/0001-Revert-bpf-fix-precision-backtracking-instruction-it.patch"
          )

          for url in "${PATCH_URLS[@]}"; do
            filename="$(basename "$url")"
            log "Downloading: $filename"

            if curl -sL -o "$filename" "$url" && [ -f "$filename" ]; then
              log "Applying: $filename"
              patch -p1 < "$filename" || log "Warning: Some hunks failed in $filename"
            else
              log "Failed to download: $filename"
            fi
          done

          log "✅ Patch processing complete"
         
      - name: "🏗 Build kernel"
        working-directory: ${{ env.WORK_DIR }}
        run: |
          export KBUILD_BUILD_USER="GitHub"
          export KBUILD_BUILD_HOST="CI"
          export SOURCE_DATE_EPOCH=$(date +%s)

          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh -j8
      
      - name: "📦 Package with AnyKernel3"
        working-directory: ${{ env.WORK_DIR}}
        run: |
          echo "Downloading AnyKernel3..."
          git clone --depth=1 https://github.com/topnotchfreaks/AnyKernel3.git -b master

          cp $OUT_DIR/dist/Image AnyKernel3/Image
          cd AnyKernel3
          zip -r9 "../kernel-${DEVICE}-${ANDROID_KERNEL_BRANCH}-$(date +%Y%m%d).zip" * -x .git/*
      
      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: GKI-$(date +%Y%m%d)
          path: kernel-GKI-common-android13-5.15-lts-*.zip  # Remove $KERNEL_DIR/
          if-no-files-found: warn